name: æ›´æ–°è´¡çŒ®å€¼æ’è¡Œæ¦œ

on:
  schedule:
    # æ¯15å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è¿è¡Œ (UTC+8 = UTC+0)
    - cron: '0 0 */15 * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/contribution.yml'
      - '.Contribution_value/contribution_calculator.py'
      - '.Contribution_value/requirements.txt'

jobs:
  update-contribution:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r .Contribution_value/requirements.txt
    
    - name: è¿è¡Œè´¡çŒ®å€¼è®¡ç®—è„šæœ¬
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd .Contribution_value
        echo "ğŸ”„ å¼€å§‹è¿è¡Œè´¡çŒ®å€¼è®¡ç®—è„šæœ¬..."
        python contribution_calculator.py
        echo "âœ… è´¡çŒ®å€¼è®¡ç®—è„šæœ¬æ‰§è¡Œå®Œæˆ"
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "è‡ªåŠ¨æ›´æ–°è´¡çŒ®å€¼æ’è¡Œæ¦œ $(date '+%Y-%m-%d %H:%M:%S')"
        git push
    
    - name: åˆ›å»ºPull Request (å¦‚æœéœ€è¦)
      if: failure()
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "è‡ªåŠ¨æ›´æ–°è´¡çŒ®å€¼æ’è¡Œæ¦œ"
        title: "è‡ªåŠ¨æ›´æ–°è´¡çŒ®å€¼æ’è¡Œæ¦œ"
        body: |
          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºçš„Pull Requestï¼Œç”¨äºæ›´æ–°è´¡çŒ®å€¼æ’è¡Œæ¦œã€‚
          
          æ›´æ–°æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')
          
          è´¡çŒ®å€¼è®¡ç®—å…¬å¼ï¼šè´¡çŒ®å€¼ = ï¼ˆåˆå¹¶PRÃ—5åˆ†ï¼‰ + ï¼ˆCommitsÃ—3åˆ†ï¼‰ + ï¼ˆæ–‡æ¡£Ã—4åˆ†ï¼‰ + ï¼ˆæœ‰æ•ˆIssuesÃ—2åˆ†ï¼‰ + ï¼ˆCode ReviewÃ—2åˆ†ï¼‰
        branch: update-contribution-leaderboard
        delete-branch: true